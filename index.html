<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panoramdle - –†–µ–∞–ª—å–Ω–æ—Å—Ç—å –∏–ª–∏ –ü–∞–Ω–æ—Ä–∞–º–∞?</title>
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --accent-color: #3b82f6;
            --success-color: #22c55e;
            --error-color: #ef4444;
            --card-bg: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- UI UTILS --- */
        .hidden { display: none !important; }
        .btn {
            background-color: var(--accent-color);
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- SCREENS --- */
        .screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        /* START SCREEN */
        .logo { font-size: 3rem; font-weight: 800; margin-bottom: 10px; color: var(--text-color); }
        .subtitle { color: #64748b; margin-bottom: 40px; max-width: 400px; line-height: 1.5; }
        .status-text { margin-top: 20px; font-size: 0.9rem; color: #94a3b8; }
        .come-back-msg { 
            margin-bottom: 20px; 
            padding: 10px; 
            background: #e0f2fe; 
            color: #0369a1; 
            border-radius: 8px; 
            font-size: 0.9rem;
        }

        /* ADMIN PANEL */
        .admin-panel {
            margin-top: 30px;
            padding: 10px;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            background: #f1f5f9;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        .admin-toggle {
            background: none;
            border: none;
            color: #94a3b8;
            font-size: 0.8rem;
            cursor: pointer;
            text-decoration: underline;
        }
        .date-picker-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        input[type="date"] {
            padding: 5px;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
        }

        /* GAME SCREEN */
        #game-screen { justify-content: flex-start; padding: 0; }
        
        /* Top Section: Image + Text */
        .card-container {
            width: 100%;
            height: 40%;
            position: relative;
            background-color: #000;
            overflow: hidden;
            display: flex;
            align-items: flex-end;
        }
        .news-img {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            opacity: 0.6;
            transition: opacity 0.3s;
        }
        .news-content {
            position: relative;
            z-index: 2;
            padding: 20px;
            width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            color: white;
            text-align: left;
        }
        .region-badge {
            display: inline-block;
            background: var(--accent-color);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        .headline {
            font-size: 1.3rem;
            font-weight: 700;
            line-height: 1.4;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        /* Bottom Section: Buttons */
        .controls-container {
            height: 60%;
            width: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            gap: 15px;
            box-sizing: border-box;
            background: white;
        }
        
        .progress-bar {
            display: flex;
            justify-content: center;
            gap: 6px;
            margin-bottom: 10px;
        }
        .dot {
            width: 8px; height: 8px;
            background-color: #e2e8f0;
            border-radius: 50%;
        }
        .dot.active { background-color: var(--accent-color); transform: scale(1.2); }
        .dot.correct { background-color: var(--success-color); }
        .dot.wrong { background-color: var(--error-color); }

        .choice-btn {
            flex: 1;
            border: 2px solid #e2e8f0;
            background: white;
            border-radius: 16px;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
        }
        .choice-btn:hover { background: #f8fafc; border-color: #cbd5e1; }
        
        .btn-real { border-color: #bfdbfe; color: #1e40af; } 
        .btn-fake { border-color: #fecaca; color: #991b1b; }

        /* OVERLAY RESULT */
        .result-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            padding: 30px;
            box-sizing: border-box;
        }
        .result-overlay.show { opacity: 1; pointer-events: auto; }
        
        .result-overlay.correct-bg { background: rgba(220, 252, 231, 0.98); }
        .result-overlay.wrong-bg { background: rgba(254, 226, 226, 0.98); }

        .res-tag { font-size: 2rem; font-weight: 800; margin-bottom: 20px; }
        .res-desc { font-size: 1.1rem; margin-bottom: 30px; line-height: 1.6; color: #334155; }
        .source-link { color: var(--accent-color); text-decoration: underline; display: block; margin-top: 10px;}

        /* FINAL SCREEN */
        .score-big { font-size: 4rem; font-weight: 900; color: var(--accent-color); margin: 0; }
        .rank-badge { 
            background: #f1f5f9; padding: 5px 15px; 
            border-radius: 20px; color: #64748b; margin-bottom: 30px; 
        }

    </style>
</head>
<body>

    <!-- START SCREEN -->
    <div id="start-screen" class="screen">
        <div class="logo">Panoramdle</div>
        <div class="subtitle">–û—Ç–ª–∏—á–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—É—é –Ω–æ–≤–æ—Å—Ç—å –æ—Ç —Å–∞—Ç–∏—Ä–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –ò–ê –ü–∞–Ω–æ—Ä–∞–º–∞.</div>
        
        <div id="come-back-msg" class="come-back-msg hidden"></div>
        
        <button id="start-btn" class="btn" disabled onclick="startGame()">–ó–∞–≥—Ä—É–∑–∫–∞...</button>
        <div id="status-text" class="status-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –Ω–æ–≤–æ—Å—Ç–µ–π...</div>

        <!-- ADMIN PANEL (Visible for testing) -->
        <div class="admin-panel">
            <button class="admin-toggle" onclick="toggleAdmin()">üõ† Debug Date (Admin)</button>
            <div id="date-controls" class="date-picker-container hidden">
                <input type="date" id="debug-date-picker">
                <button onclick="applyDebugDate()" style="padding: 5px;">Apply</button>
            </div>
        </div>
    </div>

    <!-- GAME SCREEN -->
    <div id="game-screen" class="screen hidden">
        <div class="card-container">
            <div id="news-img" class="news-img"></div>
            <div class="news-content">
                <span id="region-badge" class="region-badge">WORLD</span>
                <div id="news-headline" class="headline">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞...</div>
            </div>
        </div>

        <div class="controls-container">
            <div id="progress-bar" class="progress-bar"></div>
            <button class="choice-btn btn-real" onclick="checkAnswer('REAL')">–†–ï–ê–õ–¨–ù–û–°–¢–¨</button>
            <button class="choice-btn btn-fake" onclick="checkAnswer('FAKE')">–ò–ê –ü–ê–ù–û–†–ê–ú–ê</button>
        </div>

        <!-- RESULT OVERLAY -->
        <div id="result-overlay" class="result-overlay">
            <div id="res-tag" class="res-tag"></div>
            <div id="res-desc" class="res-desc"></div>
            <button class="btn" onclick="nextQuestion()">–î–∞–ª–µ–µ</button>
        </div>
    </div>

    <!-- FINAL SCREEN -->
    <div id="final-screen" class="screen hidden">
        <div class="subtitle">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</div>
        <div class="score-big" id="final-score">0 / 10</div>
        <div class="rank-badge" id="final-rank">–ß–∏—Ç–∞—Ç–µ–ª—å</div>
        <p>–í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∑–∞–≤—Ç—Ä–∞ –∑–∞ –Ω–æ–≤–æ–π –ø–æ—Ä—Ü–∏–µ–π –Ω–æ–≤–æ—Å—Ç–µ–π!</p>
        <button class="btn" onclick="location.reload()">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
    </div>

    <script>
        // –í–ê–ñ–ù–û: –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å—Ç—Ä–æ–∫–∞—Ö, –æ–Ω–∏ –º–æ–≥—É—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è.
        
        let fullDb = [];
        let dailySet = [];
        let currentQ = 0;
        let score = 0;
        
        let todayStr = new Date().toISOString().slice(0, 10);
        let random; 

        // --- SEEDED RANDOM (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) ---
        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                // –ò–°–ü–†–ê–í–õ–ï–ù–û: Math.imult -> Math.imul
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        
        function getDateSeed(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }

        // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—Ç—ã ---
        function updateRandomGenerator() {
            const seed = getDateSeed(todayStr);
            random = mulberry32(seed);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–µ—Ä–≤—ã–π —Ä–∞–∑
        updateRandomGenerator();

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê ---
        window.addEventListener('DOMContentLoaded', async () => {
            const startBtn = document.getElementById('start-btn');
            const statusText = document.getElementById('status-text');
            const comeBackMsg = document.getElementById('come-back-msg');
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –≤ –ø–∏–∫–µ—Ä –∞–¥–º–∏–Ω–∫–∏
            document.getElementById('debug-date-picker').value = todayStr;

            try {
                // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ LocalStorage
                checkHistory();

                // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã
                statusText.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...";

                const response = await fetch('news.json');
                if (!response.ok) throw new Error("–§–∞–π–ª news.json –Ω–µ –Ω–∞–π–¥–µ–Ω");
                
                const responseText = await response.text();
                
                // –ó–∞—â–∏—Ç–∞ –æ—Ç HTML-–æ—à–∏–±–æ–∫ –≤–º–µ—Å—Ç–æ JSON
                if (responseText.trim().startsWith('<')) throw new Error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª HTML");

                fullDb = JSON.parse(responseText);
                statusText.innerHTML = `–ë–∞–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (${fullDb.length} –Ω–æ–≤–æ—Å—Ç–µ–π)`;
                statusText.style.color = "#22c55e";

                // 3. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ —É—Å–ø–µ—à–Ω–∞)
                generateDailySet();
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ
                startBtn.disabled = false;

            } catch (e) {
                console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:", e);
                statusText.innerHTML = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å.`;
                statusText.style.color = "#ef4444";
                startBtn.innerText = "–û–®–ò–ë–ö–ê";
                // –ù–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É startBtn, —á—Ç–æ–±—ã –Ω–µ–ª—å–∑—è –±—ã–ª–æ –Ω–∞—á–∞—Ç—å –±–µ–∑ –¥–∞–Ω–Ω—ã—Ö
            }
        });

        // --- –ì–ï–ù–ï–†–ê–¶–ò–Ø ---
        function generateDailySet() {
            if (!fullDb.length) return;
            
            // –ö–ª–æ–Ω–∏—Ä—É–µ–º –±–∞–∑—É —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ä—Ç–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª –ø—Ä–∏ —à–∞—Ñ—Ñ–ª–µ
            let dbCopy = JSON.parse(JSON.stringify(fullDb));
            
            const realNews = dbCopy.filter(item => item.type === 'REAL');
            const fakeNews = dbCopy.filter(item => item.type === 'FAKE');

            shuffleArray(realNews);
            shuffleArray(fakeNews);

            const realCount = 4 + Math.floor(random() * 3);
            const fakeCount = 10 - realCount;

            const safeRealCount = Math.min(realCount, realNews.length);
            const safeFakeCount = Math.min(fakeCount, fakeNews.length);

            dailySet = [...realNews.slice(0, safeRealCount), ...fakeNews.slice(0, safeFakeCount)];
            shuffleArray(dailySet);
        }

        // --- –ò–ì–†–ê ---
        function startGame() {
            if(dailySet.length === 0) return alert("–í–æ–ø—Ä–æ—Å—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!");
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            initDots();
            loadQuestion();
        }

        function initDots() {
            const container = document.getElementById('progress-bar');
            container.innerHTML = '';
            for(let i=0; i<dailySet.length; i++) {
                let d = document.createElement('div');
                d.className = 'dot';
                d.id = 'dot-'+i;
                container.appendChild(d);
            }
        }

        function loadQuestion() {
            if (currentQ >= dailySet.length) return showResults();
            const q = dailySet[currentQ];
            document.getElementById('news-headline').innerText = q.text;
            document.getElementById('news-img').style.backgroundImage = `url('${q.img}')`;
            const region = q.region ? q.region.toUpperCase() : "WORLD";
            document.getElementById('region-badge').innerText = region;
            
            document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
            if(document.getElementById('dot-'+currentQ)) {
                document.getElementById('dot-'+currentQ).classList.add('active');
            }
        }

        function checkAnswer(userChoice) {
            const q = dailySet[currentQ];
            const isCorrect = userChoice === q.type;
            const overlay = document.getElementById('result-overlay');
            const tag = document.getElementById('res-tag');
            const desc = document.getElementById('res-desc');
            const dot = document.getElementById('dot-'+currentQ);

            overlay.className = ''; 
            if (isCorrect) {
                overlay.classList.add('show', 'correct-bg');
                tag.innerText = "–í–ï–†–ù–û!";
                score++;
                if(dot) dot.classList.add('correct');
            } else {
                overlay.classList.add('show', 'wrong-bg');
                tag.innerText = "–û–®–ò–ë–ö–ê!";
                if(dot) dot.classList.add('wrong');
            }
            
            let content = `<strong>–≠–¢–û ${q.type === 'REAL' ? '–ù–û–í–û–°–¢–¨' : '–ü–ê–ù–û–†–ê–ú–ê'}</strong><br>${q.desc}`;
            if (q.link && q.link.length > 5) {
                // –£–¥–∞–ª–µ–Ω —ç–º–æ–¥–∑–∏ –∏–∑ —Å—Å—ã–ª–∫–∏
                content += `<br><a href="${q.link}" target="_blank" class="source-link">–ò—Å—Ç–æ—á–Ω–∏–∫</a>`;
            }
            desc.innerHTML = content;
        }

        function nextQuestion() {
            document.getElementById('result-overlay').classList.remove('show');
            currentQ++;
            loadQuestion();
        }

        function showResults() {
            localStorage.setItem('lastPlayedDate', todayStr);
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
            
            document.getElementById('final-score').innerText = `${score} / ${dailySet.length}`;
            
            const percent = score / dailySet.length;
            let rank = "–ù–æ–≤–∏—á–æ–∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞";
            if(percent > 0.4) rank = "–û–ø—ã—Ç–Ω—ã–π —Å–µ—Ä—Ñ–µ—Ä";
            if(percent > 0.7) rank = "–ì—Ä–∞–Ω–¥–º–∞—Å—Ç–µ—Ä –ø–æ—Å—Ç–∏—Ä–æ–Ω–∏–∏";
            if(percent === 1) rank = "–ë–æ–≥ –Ω–æ–≤–æ—Å—Ç–Ω–æ–π –ª–µ–Ω—Ç—ã";
            
            document.getElementById('final-rank').innerText = rank;
        }

        // --- –§–£–ù–ö–¶–ò–ò –ê–î–ú–ò–ù –ü–ê–ù–ï–õ–ò –ò –ü–†–û–í–ï–†–ö–ò –ò–°–¢–û–†–ò–ò ---
        
        function checkHistory() {
            const lastPlayed = localStorage.getItem('lastPlayedDate');
            const startBtn = document.getElementById('start-btn');
            const comeBackMsg = document.getElementById('come-back-msg');
            
            if (lastPlayed === todayStr) {
                comeBackMsg.innerHTML = "–í—ã —É–∂–µ –≤—ã–ø–æ–ª–Ω–∏–ª–∏ Daily Panoramdle —Å–µ–≥–æ–¥–Ω—è.<br>–ù–æ –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —É–ª—É—á—à–∏—Ç—å —Å—á–µ—Ç –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–∫—É—á–Ω–æ ‚Äî <strong>–ø–æ–≥–Ω–∞–ª–∏ –µ—â—ë —Ä–∞–∑!</strong>";
                comeBackMsg.classList.remove('hidden');
                startBtn.innerText = "–°–´–ì–†–ê–¢–¨ –ï–©–Å –†–ê–ó";
            } else {
                comeBackMsg.classList.add('hidden');
                startBtn.innerText = "–ù–ê–ß–ê–¢–¨";
            }
        }

        function toggleAdmin() {
            const el = document.getElementById('date-controls');
            el.classList.toggle('hidden');
        }

        function applyDebugDate() {
            const picker = document.getElementById('debug-date-picker');
            if (!picker.value) return;

            todayStr = picker.value;
            currentQ = 0;
            score = 0;
            
            updateRandomGenerator(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏–¥
            generateDailySet();      // –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–æ–ø—Ä–æ—Å—ã
            checkHistory();          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å"
            
            alert(`–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${todayStr}.\n–í–æ–ø—Ä–æ—Å—ã –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã.`);
        }
    </script>
</body>
</html>
