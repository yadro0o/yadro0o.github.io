<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panoramdle</title>
    <!-- Подключаем стильные шрифты -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Палитра */
            --news-color: #2563eb;    /* Более глубокий синий */
            --panorama-color: #d97706; /* Более благородный оранжевый */
            --success-color: #10b981;
            --error-color: #ef4444;
            
            --bg-dark: #09090b;       /* Очень темный, почти черный */
            --bg-panel: rgba(255, 255, 255, 0.03);
            --border-color: rgba(255, 255, 255, 0.1);
            
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            font-family: 'Inter', sans-serif; 
            overflow: hidden; 
            height: 100vh;
        }
        
        /* Общие стили экрана */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: radial-gradient(circle at center, #18181b 0%, #000000 100%); /* Легкий градиент */
            z-index: 10;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* --- ГЛАВНЫЙ ЭКРАН --- */
        #start-screen { padding: 40px; }
        
        h1#logo { 
            font-family: 'Montserrat', sans-serif;
            font-size: 4rem; 
            margin-bottom: 0.5rem; 
            font-weight: 900; 
            text-transform: uppercase; 
            letter-spacing: 4px; 
            cursor: pointer; 
            user-select: none;
            background: linear-gradient(135deg, #fff 0%, #a1a1aa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: transform 0.3s ease;
        }
        h1#logo:hover { transform: scale(1.02); }

        .subtitle { 
            color: var(--text-muted); 
            margin-bottom: 3rem; 
            font-size: 1.1rem; 
            font-weight: 400; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        
        .btn-start {
            padding: 18px 60px; 
            font-size: 1.2rem; 
            background: var(--text-main); 
            color: #000; 
            border: none;
            text-transform: uppercase; 
            font-weight: 800; 
            letter-spacing: 1px;
            border-radius: 2px; /* Строгие углы (чуть скругленные) */
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
        }
        .btn-start:hover:not(:disabled) { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 30px rgba(255, 255, 255, 0.2);
            background: #fff;
        }
        .btn-start:disabled { 
            background-color: #333; 
            color: #666; 
            cursor: not-allowed; 
            box-shadow: none;
        }
        
        .status-text { 
            margin-top: 25px; 
            color: #52525b; 
            font-size: 0.85rem; 
            font-family: monospace; /* Технический стиль */
        }
        
        /* Сообщение о таймере */
        .timer-msg { 
            margin-top: 30px; 
            color: var(--text-muted); 
            font-size: 0.9rem; 
            background: rgba(255,255,255,0.05); 
            padding: 15px 25px; 
            border-radius: 8px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }

        /* Dev Tools */
        #admin-panel {
            margin-top: 40px; 
            padding: 20px; 
            background: rgba(0,0,0,0.8); 
            border: 1px solid #333; 
            border-radius: 12px;
            text-align: left; 
            min-width: 250px;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        #admin-panel.visible { display: block; animation: fadeIn 0.3s ease; }
        #admin-panel h3 { margin-bottom: 15px; font-size: 0.8rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        #admin-panel input { 
            width: 100%; padding: 10px; margin-bottom: 15px; 
            background: #222; border: 1px solid #444; 
            color: #fff; border-radius: 6px; 
            font-family: monospace;
        }
        #admin-panel button { 
            width: 100%; padding: 10px; cursor: pointer; 
            background: #333; color: #fff; 
            border: 1px solid #444; border-radius: 6px; 
            transition: 0.2s; 
        }
        #admin-panel button:hover { background: #444; }

        /* Telegram Link */
        .tg-link {
            position: absolute; left: 30px; bottom: 30px;
            width: 50px; height: 50px;
            border-radius: 50%;
            background: rgba(34, 158, 217, 0.1); /* Полупрозрачный фон */
            border: 1px solid rgba(34, 158, 217, 0.3);
            display: flex; align-items: center; justify-content: center;
            text-decoration: none;
            color: #229ED9;
            font-weight: 700; font-size: 14px;
            transition: all 0.3s ease;
        }
        .tg-link:hover {
            background: #229ED9; color: #fff;
            box-shadow: 0 0 20px rgba(34, 158, 217, 0.4);
            transform: scale(1.1);
        }

        /* --- ИГРОВОЙ ЭКРАН --- */
        #game-screen {
            background: var(--bg-dark);
            transition: background-color 0.4s ease; /* Плавная смена фона */
        }
        
        .progress-container {
            position: absolute; top: 30px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 12px; z-index: 50;
        }
        .dot { 
            width: 8px; height: 8px; 
            border-radius: 50%; 
            background: rgba(255,255,255,0.1); 
            transition: all 0.4s ease; 
        }
        .dot.active { background: #fff; transform: scale(1.5); box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .dot.correct { background: var(--success-color); box-shadow: 0 0 8px var(--success-color); }
        .dot.wrong { background: var(--error-color); box-shadow: 0 0 8px var(--error-color); }

        .region-badge {
            position: absolute; top: 30px; right: 30px; z-index: 55;
            background: rgba(255,255,255,0.05); 
            padding: 6px 12px; border-radius: 4px;
            font-size: 0.75rem; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(4px);
            color: var(--text-muted);
        }

        /* КНОПКИ ВЫБОРА (Общие) */
        .controls-area { display: flex; width: 100%; }
        
        .choice-btn {
            border: none; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800; text-transform: uppercase; 
            transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            position: relative;
            overflow: hidden;
        }
        /* Тонкие линии вместо грубых рамок */
        .btn-left { border-right: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.02); }
        .btn-right { border-left: 1px solid rgba(255,255,255,0.05); background: rgba(255,255,255,0.02); }

        .btn-left span, .btn-right span {
            position: relative; z-index: 2;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* --- MODE: TEXT --- */
        #game-screen.mode-text .news-display {
            position: relative; height: 40vh; width: 100%;
            background-size: cover; background-position: center;
            display: flex; align-items: flex-end; 
            /* Добавляем маску снизу, чтобы текст читался лучше */
            mask-image: linear-gradient(to bottom, black 80%, transparent 100%); 
        }
        #game-screen.mode-text .news-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* Градиент более глубокий */
            background: linear-gradient(to top, var(--bg-dark) 10%, rgba(9,9,11,0.8) 50%, rgba(9,9,11,0.4) 100%);
            z-index: 1;
        }
        #game-screen.mode-text .news-text {
            position: relative; z-index: 2; padding: 0 40px 40px 40px; width: 100%;
            text-align: center;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            color: #fff;
            text-shadow: 0 4px 20px rgba(0,0,0,0.8);
            line-height: 1.1;
        }
        #game-screen.mode-text .controls-area { height: 60vh; }
        #game-screen.mode-text .choice-btn {
            width: 50%; height: 100%; 
            font-size: 2.5rem; color: rgba(255,255,255,0.4);
            letter-spacing: 2px;
        }
        #game-screen.mode-text .btn-left:hover { background-color: var(--news-color); color: #fff; flex-grow: 1.2; }
        #game-screen.mode-text .btn-right:hover { background-color: var(--panorama-color); color: #fff; flex-grow: 1.2; }

        /* --- MODE: IMAGE --- */
        #game-screen.mode-image { flex-direction: row; }
        #game-screen.mode-image .controls-area { display: contents; }
        
        #game-screen.mode-image .choice-btn {
            width: 25%; height: 100vh;
            font-size: 1.5rem; letter-spacing: 2px;
            color: rgba(255,255,255,0.5);
            background: rgba(0,0,0,0.2); /* Чуть темнее */
            z-index: 20;
        }
        
        /* Активные цвета при наведении */
        #game-screen.mode-image .btn-left:hover { background: var(--news-color); color: #fff; width: 35%; box-shadow: 20px 0 50px rgba(0,0,0,0.5); }
        #game-screen.mode-image .btn-right:hover { background: var(--panorama-color); color: #fff; width: 35%; box-shadow: -20px 0 50px rgba(0,0,0,0.5); }

        /* Центральная часть с картинкой */
        #game-screen.mode-image .news-display {
            order: 2; flex-grow: 1;
            position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: transparent; /* Цвет задается через JS на container */
            transition: all 0.4s ease;
        }
        
        #game-screen.mode-image .img-container {
            width: 85%; max-height: 60vh;
            border-radius: 12px; 
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1); /* Строгая рамка */
            transition: all 0.4s ease;
            position: relative;
        }
        
        #game-screen.mode-image .main-image {
            width: 100%; height: 100%; object-fit: contain; display: block;
        }
        
        #game-screen.mode-image .news-text {
            margin-top: 30px; 
            font-size: 1.1rem; 
            text-align: center; 
            color: var(--text-main); 
            max-width: 70%;
            font-weight: 500;
            line-height: 1.5;
            z-index: 2;
            padding: 15px;
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        #game-screen.mode-image .news-overlay { display: none; }

        /* --- РЕЗУЛЬТАТЫ (OVERLAY) --- */
        #result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; text-align: center; padding: 20px;
            opacity: 0; pointer-events: none; 
            transition: opacity 0.3s, backdrop-filter 0.3s;
        }
        #result-overlay.show { 
            opacity: 1; pointer-events: auto; 
            backdrop-filter: blur(15px); /* Сильное размытие фона */
        }
        
        /* Используем полупрозрачные цвета для стекла */
        #result-overlay.correct-bg { background-color: rgba(16, 185, 129, 0.85); }
        #result-overlay.wrong-bg { background-color: rgba(239, 68, 68, 0.85); }
        
        .res-tag { 
            font-family: 'Montserrat', sans-serif;
            font-size: 5rem; font-weight: 900; margin-bottom: 20px; 
            text-transform: uppercase; letter-spacing: -2px;
            text-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .res-explanation { 
            font-size: 1.3rem; margin-bottom: 40px; max-width: 600px; line-height: 1.5; 
            font-weight: 500;
        }
        
        .source-link {
            display: inline-flex; align-items: center; margin-top: 10px; padding: 8px 16px;
            background: rgba(0,0,0,0.2); 
            border: 1px solid rgba(255, 255, 255, 0.4);
            border-radius: 6px; color: #fff; text-decoration: none;
            font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            transition: all 0.2s;
        }
        .source-link:hover { background: #fff; color: #000; }
        
        .btn-next {
            margin-top: 20px; padding: 15px 50px; 
            font-size: 1.2rem; background: #fff; color: #000;
            border: none; border-radius: 4px; cursor: pointer; font-weight: 800; letter-spacing: 1px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .btn-next:hover { transform: scale(1.05); }

        /* --- ФИНАЛ --- */
        #final-screen { padding: 40px 20px; }
        #final-screen h2 { font-family: 'Montserrat'; text-transform: uppercase; font-size: 2rem; margin-bottom: 10px;}
        
        .final-score { 
            font-size: 6rem; font-weight: 900; color: var(--success-color); 
            margin: 10px 0; letter-spacing: -3px;
        }
        .final-rank { 
            font-size: 1.5rem; color: var(--text-muted); margin-bottom: 40px; 
            text-transform: uppercase; letter-spacing: 2px;
            border-bottom: 1px solid #333; padding-bottom: 20px; display: inline-block;
        }
        
        .results-list {
            width: 100%; max-width: 700px; margin: 0 auto 40px;
            text-align: left; 
            background: var(--bg-panel); 
            border: 1px solid var(--border-color);
            border-radius: 12px; padding: 10px;
        }
        .result-item {
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); 
            display: flex; align-items: center; justify-content: space-between;
            transition: background 0.2s;
        }
        .result-item:hover { background: rgba(255,255,255,0.02); }
        .result-item:last-child { border-bottom: none; }
        
        .res-icon { font-size: 1.2rem; margin-right: 15px; }
        .res-text { flex-grow: 1; font-size: 1rem; color: #e4e4e7; margin-right: 15px; font-weight: 500; }
        .res-link { 
            color: var(--news-color); text-decoration: none; font-size: 0.75rem; 
            border: 1px solid rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 4px; 
            white-space: nowrap; text-transform: uppercase; letter-spacing: 0.5px;
            transition: 0.2s;
        }
        .res-link:hover { background: var(--news-color); color: #fff; border-color: transparent; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <!-- Экран 1: Старт -->
    <div id="start-screen" class="screen">
        <h1 id="logo">Panoramdle</h1>
        <div class="subtitle">Daily Reality Check</div>
        <button class="btn-start" onclick="startGame()" id="start-btn" disabled>Загрузка...</button>
        <p class="status-text" id="status-text">Подключение к базе новостей...</p>
        <div class="timer-msg hidden" id="come-back-msg"></div>

        <div id="admin-panel">
            <h3>Dev Tools</h3>
            <label style="font-size:0.8rem; color:#888;">Дата симуляции:</label>
            <input type="date" id="dev-date-input">
            <button onclick="applyDevDate()">Применить и сбросить</button>
        </div>

        <a href="https://t.me/thepanoramdle" target="_blank" rel="noopener" class="tg-link">TG</a>
    </div>

    <!-- Экран 2: Игра -->
    <div id="game-screen" class="screen hidden mode-text">
        <div class="progress-container" id="progress-bar"></div>
        
        <div class="region-badge" id="region-badge">RU</div>

        <div class="news-display" id="news-display-area">
            <div class="news-overlay"></div>
            <div class="img-container hidden" id="img-container">
                <img src="" class="main-image" id="main-image-el">
            </div>
            <div class="news-text" id="news-headline">Загрузка...</div>
        </div>

        <div class="controls-area">
            <button class="choice-btn btn-left" onclick="checkAnswer('REAL')"><span>НОВОСТЬ</span></button>
            <button class="choice-btn btn-right" onclick="checkAnswer('FAKE')"><span>ПАНОРАМА</span></button>
        </div>
    </div>

    <!-- Оверлей ответа -->
    <div id="result-overlay">
        <div class="res-tag" id="res-tag">НОВОСТЬ</div>
        <div class="res-explanation" id="res-desc">Описание...</div>
        <button class="btn-next" onclick="nextQuestion()">ДАЛЕЕ</button>
    </div>

    <!-- Экран 3: Финал -->
    <div id="final-screen" class="screen hidden">
        <h2>Результат дня</h2>
        <div class="final-score" id="final-score">0/10</div>
        <div class="final-rank" id="final-rank">Звание</div>
        <div class="results-list" id="results-list"></div>
        <button class="btn-start" onclick="location.reload()">В МЕНЮ</button>
    </div>

    <script>
        let fullDb = [];
        let dailySet = [];
        let userAnswers = []; 
        let currentQ = 0;
        let score = 0;
        
        let todayStr = localStorage.getItem('devOverrideDate') || new Date().toISOString().slice(0, 10);

        function mulberry32(a) {
            return function() {
                var t = a += 0x6D2B79F5;
                t = Math.imul(t ^ t >>> 15, t | 1);
                t ^= t + Math.imul(t ^ t >>> 7, t | 61);
                return ((t ^ t >>> 14) >>> 0) / 4294967296;
            }
        }
        function getDateSeed(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash |= 0;
            }
            return Math.abs(hash);
        }
        const seed = getDateSeed(todayStr);
        const random = mulberry32(seed); 

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function applyDevDate() {
            const val = document.getElementById('dev-date-input').value;
            if(val) {
                localStorage.setItem('devOverrideDate', val);
                localStorage.removeItem('lastPlayedDate'); 
                location.reload();
            }
        }

        window.addEventListener('DOMContentLoaded', async () => {
            const startBtn = document.getElementById('start-btn');
            const statusText = document.getElementById('status-text');
            const comeBackMsg = document.getElementById('come-back-msg');
            const devDateInput = document.getElementById('dev-date-input');
            devDateInput.value = todayStr;

            const logo = document.getElementById('logo');
            const adminPanel = document.getElementById('admin-panel');
            logo.addEventListener('click', () => {
                adminPanel.classList.toggle('visible');
            });

            // Эффекты наведения
            const leftBtn = document.querySelector('#game-screen .btn-left');
            const rightBtn = document.querySelector('#game-screen .btn-right');
            const displayArea = document.getElementById('news-display-area');
            const imgContainer = document.getElementById('img-container');
            const gameScreen = document.getElementById('game-screen');
            
            // Цвета берем из CSS переменных для синхронизации
            const rootStyles = getComputedStyle(document.documentElement);
            const newsColor = rootStyles.getPropertyValue('--news-color').trim();
            const panoColor = rootStyles.getPropertyValue('--panorama-color').trim();
            const darkBg = rootStyles.getPropertyValue('--bg-dark').trim();

            function setImageBg(color) {
                if (!gameScreen.classList.contains('mode-image')) return;
                gameScreen.style.backgroundColor = color;
                // Картинка тоже получает легкий оттенок рамки
                imgContainer.style.borderColor = 'rgba(255,255,255,0.4)';
            }
            function resetImageBg() {
                if (!gameScreen.classList.contains('mode-image')) return;
                gameScreen.style.backgroundColor = darkBg;
                imgContainer.style.borderColor = 'rgba(255,255,255,0.1)';
            }

            leftBtn.addEventListener('mouseenter', () => setImageBg(newsColor));
            leftBtn.addEventListener('mouseleave', resetImageBg);
            rightBtn.addEventListener('mouseenter', () => setImageBg(panoColor));
            rightBtn.addEventListener('mouseleave', resetImageBg);

            try {
                const lastPlayed = localStorage.getItem('lastPlayedDate');
                if (lastPlayed === todayStr) {
                    comeBackMsg.innerHTML = `Вы уже играли за дату <strong>${todayStr}</strong>.<br>Сбросьте дату в Dev Tools ниже.`;
                    comeBackMsg.classList.remove('hidden');
                    startBtn.innerText = "РЕЗУЛЬТАТЫ"; 
                } else {
                    startBtn.innerText = "НАЧАТЬ";
                }

                statusText.innerText = "Загрузка базы...";
                const response = await fetch('news.json?t=' + new Date().getTime());
                if (!response.ok) throw new Error(`Ошибка: ${response.status}`);
                const responseText = await response.text();
                
                fullDb = JSON.parse(responseText);
                if (!Array.isArray(fullDb) || fullDb.length === 0) throw new Error("База пуста");

                statusText.innerHTML = `База: ${fullDb.length} шт. <br>Дата: ${todayStr}`;
                statusText.style.color = "var(--success-color)";
                generateDailySet();
                startBtn.disabled = false;
                
            } catch (err) {
                console.error(err);
                statusText.innerText = "ОШИБКА: " + err.message;
                statusText.style.color = "var(--error-color)";
            }
        });

        function generateDailySet() {
            if (fullDb.length <= 10) {
                dailySet = shuffleArray([...fullDb]);
                return;
            }

            const realNews = fullDb.filter(item => item.type === 'REAL');
            const fakeNews = fullDb.filter(item => item.type === 'FAKE');
            shuffleArray(realNews);
            shuffleArray(fakeNews);

            const realCount = 4 + Math.floor(random() * 3); 
            const fakeCount = 10 - realCount;
            
            let combined = [...realNews.slice(0, realCount), ...fakeNews.slice(0, fakeCount)];
            // Добиваем если не хватило
            if (combined.length < 10) {
                 const remaining = [...realNews.slice(realCount), ...fakeNews.slice(fakeCount)];
                 shuffleArray(remaining);
                 combined = combined.concat(remaining.slice(0, 10 - combined.length));
            }

            dailySet = shuffleArray(combined);
        }

        function startGame() {
            if(dailySet.length === 0) return alert("База пуста!");
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            initDots();
            loadQuestion();
        }

        function initDots() {
            const container = document.getElementById('progress-bar');
            container.innerHTML = '';
            for(let i=0; i<dailySet.length; i++) {
                let d = document.createElement('div');
                d.className = 'dot';
                d.id = 'dot-'+i;
                container.appendChild(d);
            }
        }

        function loadQuestion() {
            if (currentQ >= dailySet.length) return showResults();
            
            const q = dailySet[currentQ];
            const gameScreen = document.getElementById('game-screen');
            const displayArea = document.getElementById('news-display-area');
            const headline = document.getElementById('news-headline');
            const imgContainer = document.getElementById('img-container');
            const mainImg = document.getElementById('main-image-el');

            const mode = q.mode || 'text'; 

            gameScreen.classList.remove('mode-text', 'mode-image');
            gameScreen.classList.add('mode-' + mode);
            
            // Сброс inline стилей
            gameScreen.style.backgroundColor = '';

            headline.innerText = q.text;
            document.getElementById('region-badge').innerText = q.region ? q.region.toUpperCase() : "WORLD";

            if (mode === 'text') {
                displayArea.style.backgroundImage = `url('${q.img}')`;
                imgContainer.classList.add('hidden');

                const len = (q.text || '').length;
                let fs = '2.5rem';
                if (len > 140) fs = '1.6rem';
                else if (len > 90) fs = '2rem';
                headline.style.fontSize = fs;
            } else {
                displayArea.style.backgroundImage = 'none';
                imgContainer.classList.remove('hidden');
                mainImg.src = q.img || '';
                headline.style.fontSize = '1.2rem';
            }

            document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
            if(document.getElementById('dot-'+currentQ)) {
                document.getElementById('dot-'+currentQ).classList.add('active');
            }
        }

        function checkAnswer(userChoice) {
            const q = dailySet[currentQ];
            const isCorrect = userChoice === q.type;
            const overlay = document.getElementById('result-overlay');
            const tag = document.getElementById('res-tag');
            const desc = document.getElementById('res-desc');
            const dot = document.getElementById('dot-'+currentQ);

            userAnswers.push({ text: q.text, isCorrect: isCorrect, link: q.link, type: q.type });

            overlay.className = ''; 
            if (isCorrect) {
                overlay.classList.add('show', 'correct-bg');
                tag.innerText = "ВЕРНО";
                score++;
                if(dot) dot.classList.add('correct');
            } else {
                overlay.classList.add('show', 'wrong-bg');
                tag.innerText = "ОШИБКА";
                if(dot) dot.classList.add('wrong');
            }
            
            let content = `<strong>ЭТО ${q.type === 'REAL' ? 'НОВОСТЬ' : 'ПАНОРАМА'}</strong><br>${q.desc || ''}`;
            if (q.link && q.link.length > 5) {
                content += `<br><a href="${q.link}" target="_blank" class="source-link">Источник</a>`;
            }
            desc.innerHTML = content;
        }

        function nextQuestion() {
            document.getElementById('result-overlay').classList.remove('show');
            currentQ++;
            loadQuestion();
        }

        function showResults() {
            localStorage.setItem('lastPlayedDate', todayStr);
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('final-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = `${score} / ${dailySet.length}`;
            
            const percent = score / dailySet.length;
            let rank = "Новичок";
            if(percent > 0.4) rank = "Бывалый";
            if(percent > 0.7) rank = "Эксперт";
            if(percent === 1) rank = "Провидец";
            document.getElementById('final-rank').innerText = rank;

            const listContainer = document.getElementById('results-list');
            listContainer.innerHTML = '';
            userAnswers.forEach(ans => {
                const item = document.createElement('div');
                item.className = 'result-item';
                const icon = ans.isCorrect ? '<span style="color:var(--success-color)">✔</span>' : '<span style="color:var(--error-color)">✘</span>';
                let linkHtml = ans.link && ans.link.length > 5 ? `<a href="${ans.link}" target="_blank" class="res-link">INFO</a>` : '';
                item.innerHTML = `<div class="res-icon">${icon}</div><div class="res-text">${ans.text}</div>${linkHtml}`;
                listContainer.appendChild(item);
            });
        }
    </script>
</body>
</html>
