<script>
    // ВАЖНО: Не используйте эмодзи в текстовых строках, они могут некорректно отображаться.
    
    let fullDb = [];
    let dailySet = [];
    let currentQ = 0;
    let score = 0;
    
    const todayStr = new Date().toISOString().slice(0, 10);

    // --- SEEDED RANDOM (Исправленная версия) ---
    function mulberry32(a) {
        return function() {
            var t = a += 0x6D2B79F5;
            // ИСПРАВЛЕНО: Math.imult -> Math.imul
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
    }
    
    function getDateSeed(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = ((hash << 5) - hash) + str.charCodeAt(i);
            hash |= 0;
        }
        return Math.abs(hash);
    }

    const seed = getDateSeed(todayStr);
    const random = mulberry32(seed); 

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // --- ЗАГРУЗКА ---
    window.addEventListener('DOMContentLoaded', async () => {
        const startBtn = document.getElementById('start-btn');
        const statusText = document.getElementById('status-text');
        const comeBackMsg = document.getElementById('come-back-msg');

        try {
            // 1. Проверка LocalStorage
            const lastPlayed = localStorage.getItem('lastPlayedDate');
            if (lastPlayed === todayStr) {
                comeBackMsg.innerHTML = "Вы уже выполнили Daily Panoramdle сегодня.<br>Но если хотите улучшить счет или просто скучно — <strong>погнали ещё раз!</strong>";
                comeBackMsg.classList.remove('hidden');
                startBtn.innerText = "СЫГРАТЬ ЕЩЁ РАЗ";
            } else {
                startBtn.innerText = "НАЧАТЬ";
            }

            // 2. Загрузка базы
            statusText.innerText = "Загрузка базы данных...";
            
            // Резервная база (на случай сбоя)
            const fallbackDb = [
                { id: 1, type: "REAL", region: "ru", text: "В Госдуме предложили налог на бездетность.", desc: "Такое предложение звучало от депутатов.", img: "https://placehold.co/800x600/111/FFF?text=News+1", link: "" },
                { id: 2, type: "FAKE", region: "ru", text: "Роскосмос покрасит ракеты под хохлому.", desc: "Это сатира.", img: "https://placehold.co/800x600/222/FFF?text=News+2", link: "" },
                { id: 3, type: "REAL", region: "usa", text: "Илон Маск вызвал Путина на поединок в Twitter.", desc: "Это реально было в 2022 году.", img: "https://placehold.co/800x600/333/FFF?text=News+3", link: "" },
                { id: 4, type: "FAKE", region: "world", text: "ООН запретила букву Z в алфавите.", desc: "Выдумка.", img: "https://placehold.co/800x600/444/FFF?text=News+4", link: "" },
                { id: 5, type: "REAL", region: "world", text: "Австралия проиграла войну страусам эму.", desc: "Исторический факт 1932 года.", img: "https://placehold.co/800x600/555/FFF?text=News+5", link: "" },
                { id: 6, type: "FAKE", region: "ru", text: "Сбербанк ввел комиссию за просмотр баланса глазами.", desc: "Шутка о комиссиях банков.", img: "https://placehold.co/800x600/666/FFF?text=News+6", link: "" },
                { id: 7, type: "REAL", region: "usa", text: "Кот стал мэром города на Аляске.", desc: "Кот Стаббс правил с 1997 по 2017.", img: "https://placehold.co/800x600/777/FFF?text=News+7", link: "" },
                { id: 8, type: "FAKE", region: "world", text: "Apple выпустила кирпич iBrick за $1000.", desc: "Сатира на цены компании.", img: "https://placehold.co/800x600/888/FFF?text=News+8", link: "" },
                { id: 9, type: "REAL", region: "eu", text: "В Финляндии проводятся соревнования по переноске жен.", desc: "Ежегодный чемпионат мира.", img: "https://placehold.co/800x600/999/FFF?text=News+9", link: "" },
                { id: 10, type: "FAKE", region: "eu", text: "Британские ученые доказали, что коты — жидкие.", desc: "Это старый мем, а не наука.", img: "https://placehold.co/800x600/aaa/FFF?text=News+10", link: "" },
                { id: 11, type: "REAL", region: "ru", text: "Мужчина подал в суд на самого себя и выиграл.", desc: "Реальное дело Кертиса Гоки.", img: "https://placehold.co/800x600/bbb/FFF?text=News+11", link: "" },
                { id: 12, type: "FAKE", region: "ru", text: "Минздрав рекомендовал лечить депрессию 'Сватами'.", desc: "Чистая сатира.", img: "https://placehold.co/800x600/ccc/FFF?text=News+12", link: "" }
            ];

            try {
                const response = await fetch('news.json');
                if (!response.ok) throw new Error("Файл news.json не найден");
                const responseText = await response.text();
                
                // Защита от HTML-ошибок вместо JSON
                if (responseText.trim().startsWith('<')) throw new Error("Сервер вернул HTML");

                fullDb = JSON.parse(responseText);
                statusText.innerHTML = `База загружена (${fullDb.length} новостей)`;
                statusText.style.color = "#22c55e";
            } catch (e) {
                console.warn("Сбой загрузки news.json, используем резерв:", e);
                fullDb = fallbackDb;
                statusText.innerHTML = `Не удалось загрузить news.json. Запущен демо-режим с ${fallbackDb.length} вопросами.`;
                statusText.style.color = "#f59e0b";
            }

            // 3. Генерация
            generateDailySet();
            
        } catch (globalError) {
            console.error("Критическая ошибка:", globalError);
            statusText.innerHTML = `Ошибка: ${globalError.message}`;
            statusText.style.color = "red";
        } finally {
            // 4. Эта строка включит кнопку в любом случае
            startBtn.disabled = false;
        }
    });

    // --- ГЕНЕРАЦИЯ ---
    function generateDailySet() {
        const realNews = fullDb.filter(item => item.type === 'REAL');
        const fakeNews = fullDb.filter(item => item.type === 'FAKE');

        shuffleArray(realNews);
        shuffleArray(fakeNews);

        const realCount = 4 + Math.floor(random() * 3);
        const fakeCount = 10 - realCount;

        const safeRealCount = Math.min(realCount, realNews.length);
        const safeFakeCount = Math.min(fakeCount, fakeNews.length);

        dailySet = [...realNews.slice(0, safeRealCount), ...fakeNews.slice(0, safeFakeCount)];
        shuffleArray(dailySet);
    }

    // --- ИГРА ---
    function startGame() {
        if(dailySet.length === 0) return alert("Вопросы не загружены!");
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        initDots();
        loadQuestion();
    }

    function initDots() {
        const container = document.getElementById('progress-bar');
        container.innerHTML = '';
        for(let i=0; i<dailySet.length; i++) {
            let d = document.createElement('div');
            d.className = 'dot';
            d.id = 'dot-'+i;
            container.appendChild(d);
        }
    }

    function loadQuestion() {
        if (currentQ >= dailySet.length) return showResults();
        const q = dailySet[currentQ];
        document.getElementById('news-headline').innerText = q.text;
        document.getElementById('news-img').style.backgroundImage = `url('${q.img}')`;
        const region = q.region ? q.region.toUpperCase() : "WORLD";
        document.getElementById('region-badge').innerText = region;
        
        document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
        if(document.getElementById('dot-'+currentQ)) {
            document.getElementById('dot-'+currentQ).classList.add('active');
        }
    }

    function checkAnswer(userChoice) {
        const q = dailySet[currentQ];
        const isCorrect = userChoice === q.type;
        const overlay = document.getElementById('result-overlay');
        const tag = document.getElementById('res-tag');
        const desc = document.getElementById('res-desc');
        const dot = document.getElementById('dot-'+currentQ);

        overlay.className = ''; 
        if (isCorrect) {
            overlay.classList.add('show', 'correct-bg');
            tag.innerText = "ВЕРНО!";
            score++;
            if(dot) dot.classList.add('correct');
        } else {
            overlay.classList.add('show', 'wrong-bg');
            tag.innerText = "ОШИБКА!";
            if(dot) dot.classList.add('wrong');
        }
        
        let content = `<strong>ЭТО ${q.type === 'REAL' ? 'НОВОСТЬ' : 'ПАНОРАМА'}</strong><br>${q.desc}`;
        if (q.link && q.link.length > 5) {
            // Удален эмодзи из ссылки
            content += `<br><a href="${q.link}" target="_blank" class="source-link">Источник</a>`;
        }
        desc.innerHTML = content;
    }

    function nextQuestion() {
        document.getElementById('result-overlay').classList.remove('show');
        currentQ++;
        loadQuestion();
    }

    function showResults() {
        localStorage.setItem('lastPlayedDate', todayStr);
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('final-screen').classList.remove('hidden');
        
        document.getElementById('final-score').innerText = `${score} / ${dailySet.length}`;
        
        const percent = score / dailySet.length;
        let rank = "Новичок интернета";
        if(percent > 0.4) rank = "Опытный серфер";
        if(percent > 0.7) rank = "Грандмастер постиронии";
        if(percent === 1) rank = "Бог новостной ленты";
        
        document.getElementById('final-rank').innerText = rank;
    }
</script>
